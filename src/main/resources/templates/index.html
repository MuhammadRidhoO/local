<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      type="text/css"
    />
    <title>Todo Lists</title>
    <style>
      .fixed-alert {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        z-index: 1050;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 10px;
      }
      .alert-sm {
        width: auto;
        font-size: 0.875rem;
        padding: 0.5rem 1rem;
      }
    </style>
  </head>
  <body>
    <div class="fixed-alert" id="alertContainer">
      <div
        id="successAlert"
        class="alert alert-success alert-sm d-flex align-items-center d-none"
        role="alert"
      >
        <svg
          class="bi flex-shrink-0 me-2"
          role="img"
          aria-label="Success:"
          width="20"
          height="20"
        >
          <use xlink:href="#check-circle-fill" />
        </svg>
        <div>Task status updated successfully.</div>
      </div>
    </div>
    <div class="fixed-alert" id="alertDeleteContainer">
      <div
        id="successDeleteAlert"
        class="alert alert-success alert-sm d-flex align-items-center d-none"
        role="alert"
      >
        <svg
          class="bi flex-shrink-0 me-2"
          role="img"
          aria-label="Success:"
          width="20"
          height="20"
        >
          <use xlink:href="#check-circle-fill" />
        </svg>
        <div>Task deleted successfully.</div>
      </div>
    </div>
    <div class="container-sm mt-3" style="width: 60%">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="fs-3">Task List</h1>
        <button
          type="button"
          class="btn btn-primary"
          data-bs-toggle="modal"
          data-bs-target="#createTaskModal"
        >
          Create Task
        </button>
      </div>

      <div
        class="row row-cols-1 g-3"
        th:each="todo : ${todos}"
        style="padding-top: 10px"
      >
        <div class="col">
          <div class="card">
            <div
              class="card-body d-flex justify-content-between align-items-center"
            >
              <div class="d-flex align-items-center">
                <input
                  class="form-check-input me-2"
                  type="checkbox"
                  th:checked="${todo.isComplete}"
                  th:attr="data-id=${todo.id}"
                  onchange="toggleComplete(this)"
                />
                <p
                  class="mb-0"
                  th:classappend="${todo.isComplete} ? 'completed' : ''"
                  th:text="${todo.subTitle}"
                ></p>
              </div>
              <div class="d-flex gap-2">
                <button
                  type="button"
                  class="btn btn-success btn-sm"
                  data-bs-toggle="modal"
                  data-bs-target="#modal"
                  th:attr="data-id=${todo.id}"
                  onclick="openModal(this)"
                >
                  Detail
                </button>
                <button
                  type="button"
                  class="btn btn-primary btn-sm"
                  data-bs-toggle="modal"
                  data-bs-target="#editModal"
                  th:attr="data-id=${todo.id}"
                  onclick="openEditModal(this.getAttribute('data-id'))"
                >
                  Edit
                </button>
                <button
                  type="button"
                  class="btn btn-danger btn-sm"
                  th:attr="data-id=${todo.id}"
                  onclick="deleteTask(this)"
                >
                  Delete
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modals -->
    <!-- Modal Create -->
    <div
      class="modal fade"
      id="createTaskModal"
      tabindex="-1"
      aria-labelledby="createTaskModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="createTaskModalLabel">New Task</h1>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="createTaskForm">
              <div class="mb-3">
                <label for="taskSubTitle" class="col-form-label"
                  >Sub Title:</label
                >
                <input type="text" class="form-control" id="taskSubTitle" />
              </div>
              <div class="mb-3">
                <label for="taskDescraption" class="col-form-label"
                  >Description:</label
                >
                <textarea class="form-control" id="taskDescraption"></textarea>
              </div>
              <div class="mb-3">
                <label for="taskFinishAt" class="col-form-label"
                  >Finish Date:</label
                >
                <input
                  type="date"
                  class="form-control"
                  id="taskFinishAt"
                  required
                />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="createTask()"
            >
              Create Task
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Edit -->
    <div
      class="modal fade"
      id="editModal"
      tabindex="-1"
      aria-labelledby="editModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="editModalLabel">Edit Task</h1>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="editTaskForm">
              <div class="mb-3">
                <label for="editTaskSubTitle" class="col-form-label"
                  >Sub Title:</label
                >
                <input type="text" class="form-control" id="editTaskSubTitle" />
              </div>
              <div class="mb-3">
                <label for="editTaskDescription" class="col-form-label"
                  >Description:</label
                >
                <textarea
                  class="form-control"
                  id="editTaskDescription"
                  style="resize: none"
                  cols="30"
                  rows="5"
                ></textarea>
              </div>
              <div class="mb-3">
                <label for="editTaskFinishAt" class="col-form-label"
                  >Finish Date:</label
                >
                <input
                  type="date"
                  class="form-control"
                  id="editTaskFinishAt"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="editTaskIsComplete" class="col-form-label"
                  >Status:</label
                >
                <input type="checkbox" id="editTaskIsComplete" />
                <label for="editTaskIsComplete">Done</label>
              </div>
              <div class="modal-footer">
                <button type="submit" class="btn btn-success">Edit</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Detail -->
    <div
      class="modal fade"
      id="modal"
      tabindex="-1"
      aria-labelledby="exampleModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="exampleModalLabel">Detail Task</h1>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <h5 class="card-title" id="modalSubTitle"></h5>
            <p
              class="card-text"
              id="modalDescraption"
              style="padding-top: 10px"
            ></p>
            <p class="card-text" id="modalDaysBetween">
              <small class="text-body-secondary"></small>
            </p>
          </div>
          <div class="modal-footer">
            <button id="undoneButton" type="button" class="btn btn-danger">
              UnDone
            </button>
            <button id="doneButton" type="button" class="btn btn-success">
              Done
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div
      class="modal fade"
      id="deleteConfirmModal"
      tabindex="-1"
      aria-labelledby="deleteConfirmModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteConfirmModalLabel">
              Confirm Delete
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            Are you sure you want to delete this task?
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-danger"
              id="confirmDeleteButton"
            >
              Delete
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- SVG Icons -->
    <svg xmlns="http://www.w3.org/2000/svg" class="d-none">
      <symbol id="check-circle-fill" viewBox="0 0 16 16">
        <path
          d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.061 1.061l2.646 2.647a.75.75 0 0 0 1.08-.022l4.75-5.25a.75.75 0 0 0-.022-1.08z"
        />
      </symbol>
    </svg>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      type="text/javascript"
    ></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
      // ===== Get By Id =====

      function openModal(button) {
        const id = button.getAttribute("data-id");
        $.ajax({
          url: "/api/v1/todo/" + id,
          method: "GET",
          success: function (data) {
            $("#modalSubTitle").text(data.subTitle);
            $("#modalDescraption").text(data.descraption);
            $("#modalDaysBetween").text(formatDate(data.finishAt));
            updateModalButtons(data.isComplete);
            $("#modal").modal("show");
          },
        });
      }

      // ===== POST =====

      function createTask() {
        const taskData = {
          subTitle: $("#taskSubTitle").val(),
          descraption: $("#taskDescraption").val(),
          finishAt: $("#taskFinishAt").val(),
        };
        $.ajax({
          type: "POST",
          url: "/api/v1/todo/",
          data: JSON.stringify(taskData),
          contentType: "application/json",
          success: function (response) {
            alert("Task created successfully");
            location.reload();
          },
          error: function () {
            alert("Failed to create task");
          },
        });
      }

      // ===== PATCH =====

      function openEditModal(id) {
        $.ajax({
          url: "/api/v1/todo/" + id,
          method: "GET",
          success: function (data) {
            $("#editTaskSubTitle").val(data.subTitle);
            $("#editTaskDescription").val(data.descraption);
            $("#editTaskFinishAt").val(data.finishAt);
            $("#editTaskIsComplete").prop("checked", data.isComplete);
            $("#editTaskForm").data("id", id);
          },
          error: function () {
            alert("Failed to fetch task details.");
          },
        });
      }

      $(document).ready(function () {
        $("#editTaskForm").submit(function (event) {
          event.preventDefault();
          const id = $(this).data("id");
          const subTitle = $("#editTaskSubTitle").val();
          const description = $("#editTaskDescription").val();
          const finishAt = $("#editTaskFinishAt").val();
          const isComplete = $("#editTaskIsComplete").is(":checked");

          $.ajax({
            url: "/api/v1/todo/" + id,
            method: "PATCH",
            contentType: "application/json",
            data: JSON.stringify({
              subTitle: subTitle,
              descraption: description,
              finishAt: finishAt,
              isComplete: isComplete,
            }),
            success: function (data) {
              $("#editModal").modal("hide");
              location.reload();
            },
            error: function () {
              alert("Failed to update task.");
            },
          });
        });
      });

      // ===== Check Box =====

      function toggleComplete(checkbox) {
        const id = checkbox.getAttribute("data-id");
        const isComplete = checkbox.checked;

        $.ajax({
          url: "/api/v1/todo/checkbox/" + id,
          method: "PATCH",
          contentType: "application/json",
          data: JSON.stringify({
            isComplete: isComplete,
          }),
          success: function (data) {
            console.log("Task status updated.");
            showAlert("successAlert");

            // Update the UI
            const taskElement = checkbox
              .closest(".card-body")
              .querySelector(".mb-0");
            if (isComplete) {
              taskElement.classList.add("completed");
            } else {
              taskElement.classList.remove("completed");
            }
          },
          error: function () {
            alert("Failed to update task status.");
          },
        });
      }
      // ===== Fungsi Done dan Undone =====

      function updateModalButtons(isComplete) {
        console.log("isComplete:", isComplete);
        const undoneButton = document.getElementById("undoneButton");
        const doneButton = document.getElementById("doneButton");

        if (isComplete) {
          doneButton.style.display = "block";
          undoneButton.style.display = "none";
        } else {
          doneButton.style.display = "none";
          undoneButton.style.display = "block";
        }
      }

      // ===== DELETE =====

      function deleteTask(button) {
        const id = button.getAttribute("data-id");

        if (confirm("Are you sure you want to delete this task?")) {
          $.ajax({
            url: "/api/v1/todo/" + id,
            method: "DELETE",
            success: function () {
              showAlertDelete("successDeleteAlert");

              const taskElement = document.querySelector(
                `.task[data-id='${id}']`
              );
              if (taskElement) {
                taskElement.remove();
              }
            },
            error: function () {
              alert("Failed to delete task");
            },
          });
        }
      }

      // ===== Show Alert Bootstrap 5 =====

      function showAlert(alertId) {
        const alertElement = document.getElementById(alertId);
        alertElement.classList.remove("d-none");
        alertElement.classList.add("show");

        setTimeout(function () {
          alertElement.classList.remove("show");
          alertElement.classList.add("d-none");
        }, 3000);
      }

      function showAlertDelete(alertIdDelete) {
        const alertElement = document.getElementById(alertIdDelete);
        alertElement.classList.remove("d-none");
        alertElement.classList.add("show");

        setTimeout(function () {
          alertElement.classList.remove("show");
          alertElement.classList.add("d-none");
        }, 3000);
      }

      // ===== Format Tanggal =====

      function getOrdinalSuffix(n) {
        let s = ["th", "st", "nd", "rd"],
          v = n % 100;
        return n + (s[(v - 20) % 10] || s[v] || s[0]);
      }

      function formatDate(dateStr) {
        const date = new Date(dateStr);
        const day = getOrdinalSuffix(date.getDate());
        const month = date.toLocaleString("default", { month: "short" });
        const year = date.getFullYear();
        return `${day} ${month} ${year}`;
      }

      // ===== Notice Confirm Delete

      function deleteTask(button) {
        taskIdToDelete = button.getAttribute("data-id");
        const deleteConfirmModal = new bootstrap.Modal(
          document.getElementById("deleteConfirmModal")
        );
        deleteConfirmModal.show();
      }

      document
        .getElementById("confirmDeleteButton")
        .addEventListener("click", function () {
          $.ajax({
            url: "/api/v1/todo/" + taskIdToDelete,
            method: "DELETE",
            success: function () {
              showAlertDelete("successDeleteAlert");

              // Hapus elemen tugas dari DOM
              const taskElement = document.querySelector(
                `.task[data-id='${taskIdToDelete}']`
              );
              if (taskElement) {
                taskElement.remove();
              }
            },
            error: function () {
              alert("Failed to delete task");
            },
          });

          const deleteConfirmModal = bootstrap.Modal.getInstance(
            document.getElementById("deleteConfirmModal")
          );
          deleteConfirmModal.hide();
        });
    </script>
  </body>
</html>
